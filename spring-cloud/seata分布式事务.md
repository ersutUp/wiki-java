# Seataåˆ†å¸ƒå¼äº‹åŠ¡



**åŸºç¡€ï¼š[äº‹åŠ¡çš„éš”ç¦»æ€§](./../spring/transaction.md#Isolation)**



## Seataæœ¯è¯­

**TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…**
ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

**TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨**
å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼šå¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚

**RM (Resource Manager) - èµ„æºç®¡ç†å™¨**
ç®¡ç†åˆ†æ”¯äº‹åŠ¡å¤„ç†çš„èµ„æºï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚

## å…¨å±€é”

**æ¯ä¸ªå…¨å±€äº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå…¨å±€é”**

### ğŸ’¡å…¨å±€é”çš„å†…å®¹

- å…¨å±€äº‹åŠ¡id
- åˆ†æ”¯äº‹åŠ¡id
- **é”å®šèµ„æºçš„ä¿¡æ¯**

  - è¡¨å

  - è¡Œ
- ç­‰

chatgptçš„å›ç­”ï¼š

<img src="./images/seata-lock.png" style="zoom: 50%;" />

### â­ï¸å…¨å±€é”å¦‚ä½•å®ç°å†™éš”ç¦»

å®˜æ–¹çš„å†™éš”ç¦»æ–‡æ¡£ï¼šhttps://seata.apache.org/zh-cn/docs/overview/what-is-seata#%E6%95%B4%E4%BD%93%E6%9C%BA%E5%88%B6

â­ï¸å®˜æ–¹æ–‡æ¡£æŒ‡å‡ºäº†æè¿°äº†å†™éš”ç¦»çš„æ‰§è¡Œé€»è¾‘ä»¥åŠå†™éš”ç¦»é€šè¿‡å…¨å±€é”å®ç°ï¼Œä½†æ˜¯<span style="color:red">æœªè¯´æ˜å…¨å±€é”æ˜¯å¦‚ä½•å®ç°çš„å†™éš”ç¦»</span>

**ä¸€äº›ä¸ªäººç†è§£**ï¼š

å»TCæŸ¥è¯¢æ‰€æœ‰çš„å…¨å±€é”æ˜¯å¦åŒ…å«å°†è¦é”å®šçš„èµ„æº

- å¦‚æœæ²¡æœ‰åˆ™**è·å–è¯¥å…¨å±€äº‹åŠ¡çš„å…¨å±€é”ï¼Œå¹¶å¾€å…¨å±€é”ç§å†™å…¥è¯¥èµ„æºè¿›è¡Œé”å®š**
- å¦‚æœæœ‰ï¼Œåˆ™é‡æ–°æŸ¥è¯¢è¯¥èµ„æº

### ğŸ™…ğŸ»â€â™€ï¸å¯¹å†™éš”ç¦»æ—¶ é¿å…è„å†™ çš„è¡¥å……

> å…ˆé˜…è¯»ï¼šhttps://seata.apache.org/zh-cn/docs/user/appendix/isolation#%E6%80%8E%E4%B9%88%E7%94%A8seata%E9%98%B2%E6%AD%A2%E8%84%8F%E5%86%99

[å®˜æ–¹æ–‡æ¡£](https://seata.apache.org/zh-cn/docs/user/appendix/isolation#%E6%80%8E%E4%B9%88%E7%94%A8seata%E9%98%B2%E6%AD%A2%E8%84%8F%E5%86%99)ä¸­æŒ‡å‡ºé€šè¿‡ `@GlobalTransactional`æ³¨è§£çš„äº‹åŠ¡**æœªè·å–åˆ°å…¨å±€é”**æŠ›å‡º`LockConflictException`ï¼Œæœªè¯´æ˜é‡è¯•æœºåˆ¶ï¼ˆå…·ä½“é…ç½®é¡¹ï¼šretryIntervalå’ŒretryTimesã€ç›¸å…³ç±»ï¼š`LockRetryController.java`ï¼‰

å®˜æ–¹æ³³é“å›¾ï¼š<img src="./images/prevent-dirty-write-by-GlobalTransaction-7a7b3233283a355ca3a609e67841e43c.png" style="zoom:50%;" />



æŠ›å‡ºå¼‚å¸¸`LockConflictException`åï¼Œè¢«æ•è·å¹¶è¿›å…¥`LockRetryController.java`çš„`sleep`æ–¹æ³•ä¼‘çœ ï¼Œä¹‹åå†é‡è¯•ã€‚



ä¸**@GlobalLock + select for update**çš„åŒºåˆ«

- @GlobalLock + select for updateï¼šé‡è¯•æ—¶ä¼šé‡Šæ”¾æœ¬åœ°é”
- @GlobalTransactionalï¼šé‡è¯•æ—¶ä¸é‡Šæ”¾æœ¬åœ°é”ï¼ˆæºç ä½ç½®`SelectForUpdateExecutor#doExecute`ï¼‰

[æºç éƒ¨åˆ†çš„è§£é‡Š](./md)



### <div id="AT-2"></div>äºŒé˜¶æ®µæµç¨‹ï¼ˆATæ¨¡å¼ï¼‰

å®˜æ–¹è¯´æ˜ï¼šhttps://seata.apache.org/zh-cn/docs/overview/what-is-seata#%E4%B8%80%E9%98%B6%E6%AE%B5

#### ä¸€é˜¶æ®µ

1. è§£æsqlè·å–å…ƒæ•°æ®ï¼ˆæ“ä½œç±»å‹ã€è¡¨ã€æ¡ä»¶ï¼‰
2. è·å–æ‰§è¡Œsqlå‰é•œåƒæ•°æ®
3. æ‰§è¡Œsql
4. è·å–æ‰§è¡Œsqlåé•œåƒæ•°æ®
5. å°†å‰åé•œåƒæ•°æ®å­˜å…¥undo_logè¡¨
6. **å‘TCæ³¨å†Œäº‹åŠ¡åˆ†æ”¯å¹¶è·å–å…¨å±€é”**
7. æäº¤æœ¬åœ°äº‹åŠ¡ï¼šä¸šåŠ¡æ•°æ®å’Œundo_logçš„æ•°æ®
8. å‘TCæŠ¥å‘Šæ‰§è¡Œç»“æœ

<img src="./images/seata-AT-1.png" style="zoom:40%;" />

#### äºŒé˜¶æ®µ-æäº¤

1. æ”¶åˆ°TCçš„æäº¤ä¿¡æ¯ï¼Œæ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—ï¼Œé©¬ä¸Šè¿”å›æäº¤æˆåŠŸçš„æ•°æ®
2. å¼‚æ­¥åˆ é™¤undo_logå¯¹åº”çš„æ•°æ®

![å›¾ç‰‡æ¥æºhttps://www.cnblogs.com/chengxy-nds/p/14046856.html](./images/seata-commit.png)

#### äºŒé˜¶æ®µ-å›æ»š

1. æ”¶åˆ°TCçš„å›æ»šä¿¡æ¯ï¼Œå¼€å¯æœ¬åœ°äº‹åŠ¡
2. æŸ¥è¯¢undo_logå¯¹åº”çš„æ•°æ®
3. **æ•°æ®æ ¡éªŒ**ï¼šéªŒè¯åé•œåƒæ•°æ®ä¸å½“å‰æ•°æ®æ˜¯å¦æœ‰å˜æ›´ï¼Œå¦‚æœæœ‰ä¸åŒï¼Œè¯´æ˜æ•°æ®è¢«å½“å‰å…¨å±€äº‹åŠ¡ä¹‹å¤–çš„åŠ¨ä½œåšäº†ä¿®æ”¹ï¼ˆæ¯”å¦‚æœªè¢«seataæ¥ç®¡äº‹åŠ¡ã€æ‰‹åŠ¨ä¿®æ”¹ç­‰ï¼‰ã€‚è¿™ç§æƒ…å†µæ ¹æ®é…ç½®ç­–ç•¥æ¥åšå¤„ç†ã€‚[å‚è€ƒé“¾æ¥](https://github.com/apache/incubator-seata/issues/3616)ã€[å‚è€ƒé“¾æ¥](https://blog.csdn.net/m0_47066332/article/details/122073027)
4. åå‘è§£æå¹¶ç”Ÿæˆè¡¥å……sqlï¼Œæ‰§è¡Œsql
5. æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œå¹¶æŠŠæœ¬åœ°äº‹åŠ¡çš„æ‰§è¡Œç»“æœä¸ŠæŠ¥ç»™ TCã€‚

![å›¾ç‰‡æ¥æºhttps://www.cnblogs.com/chengxy-nds/p/14046856.html](./images/seata-rollback.png)

## éƒ¨ç½²

> å®˜æ–¹çš„docker-composeéƒ¨ç½²æ–‡æ¡£ï¼šhttps://seata.apache.org/zh-cn/docs/ops/deploy-by-docker-compose#nacos-db

docker-composeéƒ¨ç½²ç¤ºä¾‹ï¼šhttps://github.com/ersutUp/docker-info/tree/master/seata

## å®æ“

